// SPDX-License-Identifier: MIT
// Creator: @casareafer at 1TM.io

/*

         _______                   _____                    _____                    _____                    _____
        /::\    \                 /\    \                  /\    \                  /\    \                  /\    \
       /::::\    \               /::\____\                /::\    \                /::\    \                /::\____\
      /::::::\    \             /::::|   |               /::::\    \              /::::\    \              /:::/    /
     /::::::::\    \           /:::::|   |              /::::::\    \            /::::::\    \            /:::/    /
    /:::/~~\:::\    \         /::::::|   |             /:::/\:::\    \          /:::/\:::\    \          /:::/    /
   /:::/    \:::\    \       /:::/|::|   |            /:::/__\:::\    \        /:::/  \:::\    \        /:::/    /
  /:::/    / \:::\    \     /:::/ |::|   |           /::::\   \:::\    \      /:::/    \:::\    \      /:::/    /
 /:::/____/   \:::\____\   /:::/  |::|   | _____    /::::::\   \:::\    \    /:::/    / \:::\    \    /:::/    /      _____
|:::|    |     |:::|    | /:::/   |::|   |/\    \  /:::/\:::\   \:::\    \  /:::/    /   \:::\    \  /:::/____/      /\    \
|:::|____|     |:::|    |/:: /    |::|   /::\____\/:::/__\:::\   \:::\____\/:::/____/     \:::\____\|:::|    /      /::\____\
 \:::\    \   /:::/    / \::/    /|::|  /:::/    /\:::\   \:::\   \::/    /\:::\    \      \::/    /|:::|____\     /:::/    /
  \:::\    \ /:::/    /   \/____/ |::| /:::/    /  \:::\   \:::\   \/____/  \:::\    \      \/____/  \:::\    \   /:::/    /
   \:::\    /:::/    /            |::|/:::/    /    \:::\   \:::\    \       \:::\    \               \:::\    \ /:::/    /
    \:::\__/:::/    /             |::::::/    /      \:::\   \:::\____\       \:::\    \               \:::\    /:::/    /
     \::::::::/    /              |:::::/    /        \:::\   \::/    /        \:::\    \               \:::\__/:::/    /
      \::::::/    /               |::::/    /          \:::\   \/____/          \:::\    \               \::::::::/    /
       \::::/    /                /:::/    /            \:::\    \               \:::\    \               \::::::/    /
        \::/____/                /:::/    /              \:::\____\               \:::\____\               \::::/    /
         ~~                      \::/    /                \::/    /                \::/    /                \::/____/
                                  \/____/                  \/____/                  \/____/                  ~~

                                                 _______________________
                                               //   __..--~~~~--..__    \\
                                              ||___/  |  |   |  |   \ __/ |
                                              ||  /   ___________    \    |
                                              ||_/   /.......... \    |   |
                                              | |   /..........   \   |   |
                         _____________________| |  /...........    \  |   |________________
                          ;   . . .   .       |_| |...........      | |   | .''."...  ... .
                         ___   ..~.         _.' | |..........       | |   |         . ~
                          .      '     .   / \_.| |..........       | |   |\ ~.   ._..---._
                                          |. /| \ \............     / /   |/ .    /\      /\
                            '""" ... ~~~  | \|| _\ \............   / /-.__|      // ~-._./ -\
                          ..~             |  |_.~\\ \_____________/ /// '.|     /__       __.\
                          ___   ..~.      |_.~    \\_______________//   _ ~-.  ~~~~..  ~~~~~.
                                         .~ -.     \__.---.________/   ______\.
                         .''."...  ... ./\        _|      |---|  = |__ \__\===\   '""" ... ~~~
                                       /  '.  .  |_|=     |---|    | _| \======\ ___   ..~.
                           ..~        / .   \      |=     |___|    ||       __. \
                                     /           _ |_______________|   _.        \
                         .''."...  ./                /   \___    ~~  \            \  '" ..   ~~
                                   /          '' /   \      /         \           /\
                         ___   .  /     -- .   /'   __\____/       ____\___.'   --  \ ___   ..~.
                                 /            /    / \\ --  _____//          ~ - .   \
                          ..--  /_..-       ./.   /  _/   _|___  \\       .     -   _/)
                               /   ___     ./|__  / _/   (_____ / \\  .          \ ~ /   .
                           .  /___////_   /  |   / _/    (_____ \  \\       _./ ..__/
                             /___/__/_ \ /  _|  /__/ _-- (_____  \: \\_____________/      ._
                         _  /         \ /_.' | /  /       (_________/ ~~-|
                           /           //   _|/  /-              .    __ |..~. _____ -.. '  "
                         ..\==========/'   \_/ _/  __      ___..     /  \|
                             / _____  \'.______/___....------......__\__/|
                         '  |          \     |\__________________|__|___/|  ~~~~~..   - ~  '
                          ~ |        _  \   /~      \     \ --  /         \
                            | | | | | \_|  |   \     \ ~      //           |
                         _. |_| | | | .    |-----..   \       /  /-      __|..~. _____ -.. '  "
                              |_|_|_|   _. |       \_  \\ _ ./          ___|
                          ~~~  ..   - ~  ' |         \__\___/__...------   |  ~~~~~..   - ~  '
                                           |  .-         | | .       __    |
                                           |     __..    | |    ______     |      .     ~
                        ..~. _  __ -.. '   \           __| |   |      |    | _        .
                                           /             | | ~ |__.___|.   |
                                           |    __       | |   |      |    |              .. '
                          ~~~~~..   - ~  ' | ''          / \   |      |    |___     __.
                          ....   -         |  _____...   | |   \______/    |  ~~~~~..   - ~  '
                                           | /        '--| |      ~~       |
                             ~..   - ~  '  |/            | |    __----  .. |   .      .     _
                                           ||____......._| |               |
                                           |----         | |               |  ~~~~~..   - ~  '
                           '""" ... ~~~    |       -.    | |       _..     |
                                           | ..         // |               | _~"".    .
                                           |          -  \ | __----.   ..  \
                          ~~~..   - ~  '   |_____________| |_______________/
                                           \_____________| |______________/   '    ...  __  ~
                                            /     ----- \   /----------- \
                           __~~..   - ~  ' /___      ----\ /--...___      \
                                          /    ..--      | | __..     ___./  .     .   ~
                              - ~  '..    \  __________./  |_____________/  .   - ~  ' ~~~~
                          ..._____~~~~~~JRO\___________/    \___________/  -_______...._____
                        ..            ___ . ~~~~~~~~~~~. __\ ~~~~~~~~~~~~~...      _  ~
                        __    ....         ''        ...""       ....'''      -_~~~     ~~~...

*/

pragma solidity ^0.8.17;

import "./PioneerPassToken.sol";

contract PioneerPass is PioneerPassToken {
    string public name = "1CU Pioneer Pass";
    string public symbol = "PNRP";

    constructor(string memory _contractURI, address royaltyAddress) PioneerPassToken(_contractURI, royaltyAddress){}

    function mint(bytes32[] calldata _merkleProof, uint256 _passId, uint16 _amount, bool whitelisted) external payable callerIsUser {
        Library.Pass storage pass = passIdToCollectionPass[_passId];
        require(pass.passId > 0, "Invalid Pass");
        require(pass.preSale || pass.publicSale, "No active sales");
        if (whitelisted) {
            require(!PioneerPassStorage.whitelistMinted[msg.sender][_passId], "Already minted");
            require(Library.ValidatePresaleMint(pass, _amount, true, _merkleProof));
            PioneerPassStorage.whitelistMinted[msg.sender][_passId] = true;
        } else if (pass.preSale) {
            require(_passId != 1, "No pre-sale for the ark");
            require(!PioneerPassStorage.presaleMinted[msg.sender][_passId], "Already minted");
            for (uint bar = 0; bar < _passId - 1; bar++) {
                require(balanceOf(msg.sender, passIdIndex[bar]) > 0, "Does not own previous tokens");
            }
            require(Library.ValidatePresaleMint(pass, _amount, false, _merkleProof));
            PioneerPassStorage.presaleMinted[msg.sender][_passId] = true;
        } else {
            uint16 _hodls;
            if (balanceOf(msg.sender, passIdIndex[0]) > 0) {
                if (_passId > 1) {
                    for (uint bar = 0; bar < _passId - 1; bar++) {
                        if (balanceOf(msg.sender, passIdIndex[bar]) > 0) {
                            _hodls += 1;
                        }
                    }
                }
            }
            else {
                _hodls = 0;
            }
            require(Library.ValidatePublicMint(pass, _amount, _hodls));
        }
        pass.totalMinted += _amount;
        _mint(msg.sender, _passId, _amount, "");
    }

    function reservedMints(uint256 _passId, uint16 _amount) external payable onlyOwner {
        Library.Pass storage pass = passIdToCollectionPass[_passId];
        require(pass.passId > 0, "Invalid Pass");
        require(pass.maxSupply >= _amount + pass.totalMinted, "Exceeds available supply");
        pass.totalMinted += _amount;
        _mint(msg.sender, _passId, _amount, "");
    }
}