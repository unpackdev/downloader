// SPDX-License-Identifier: UNLICENSED

/*
IN DUANE WE TRUST

https://t.me/fmantoken
https://www.floridamantoken.com
https://x.com/floridamantoken

MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWNNNNNNNNNNNNNNNNWWWWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNNXKKKK0000OOOOOOOOOOOOOO0000KKKKXXXNNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXXK00OOOkxxdddoolllccccccccccccclllooddxkkO00KKXXNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXK00Okkxddolc::;;;:::ccccccccllccccclcc::::;;::cloddkOO00KXNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXK0Okkxdolc:;;:cccllloodollllooloddoollodxoodxdolcccc::;:clodxkO0KXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNK0Okxxdlc:;;clllodxkdooolodoccolcccllllllcclolldxdooooodxxdocc:;;:loxkO0KXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNKOkxxdoc;;:ccloxxxoodxxxl::;coooodc,',::ccoxxxxdddxxoodxxdxkxdoddxdlc:;;:ldxOO0XNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNKOkxxol:;:clldxxoloodolool;'',:clollc;..''''',:oxkkkxdkkxddddddoclddxxodxllc:;;coxOO0XNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMWXOkxxdl:;:cclooodxkxooooll:,,,,,;ldxkxxd;........';cokOkoldkOkxolldoloddodxddoooolc;;cdkOOKXWMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMWKkxxdl:;;codddollodxxxolool;'.';lodxkkxxdddc'.......',:okOkdodxxkOkdoooolloxddoooodxxol:;:ldkO0XWMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMN0kxxoc;;:cloddxxxdoloooddodo;....;ldddddoollcc:.....'''',:okkdocloxxddddoodoolollooddddoollc;,:okOOKNMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMW0xddo:,;coddlllooddddooodxxxo;.....,cloddoolccc:;'.'''',;ccclxkoloccdxlccododxkkxddoododddxdoodl:,:oxkOKNMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMW0xddo:,;:codddoccllllldxkxxxxo,''....,;:loool::cll:'';,,',',lllodol::cool:;:looodkkkkxddlldxxdooxdol:,;lxkOKWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMWXkddo:,;loollloddlldxdxxkkkkkxc,'''....',;lll::clllcc:';c:,';,;oollllc;:ol:;;;;:ccldxkkkkkxoooooodddoooo:,:oxkOXWMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMNOdddc,;clloddoclooloxkkkkkkkkd:''',:'.....':cc::cododxkc'.,l;.;;cdoc:clccllc;;:cccccloxkkkkkkkxxdddoodxxdoc;,:dkkONMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMKxddl;,:odlccccclccodkkkkkkkkkd;...';'.......';cl::looxkkl,'':l,':col;;::clollol:clc::cloxkkkkkkkkxoloxxddocclc;,cxkkKWMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMW0ddo:,,:loddocccllldxxkkkkkkkkx:....''..........,;:::ldxkkl,,;:c:',cooc;cc;;oxddxddddoloddooxkkkOOkkkxdlllllclloo:,;okxONMMMMMMMMMMMMMM
MMMMMMMMMMMMMNkodl;,;:cccloolccoddxxxxkkkkkkkd,.................';;;oxxkxc,;coc:,.;odl;:lc,,:lodxkkOkoccc:;:ldkOOOkkkkdollllloddoc,,lxxkXMMMMMMMMMMMMM
MMMMMMMMMMMMXxodc,;clccc::ccccoddxxxxxkkkkkkkd,......';,'........;,;dxxkx;,:ldl:;'':lc:::c::;,,;:c::;;::;,'',lxkkOkkkkkkdloxxddlllc;,:dxxKWMMMMMMMMMMM
MMMMMMMMMMMXdodc,;cooolccccclodddxxxxxxxkkkkkd;......,,,.........''cxxkkd;''cxxl;,'',;::;::::clcc:;;:c:;,...':lxkkkkkkkxxdollllooddl;,:dxxKWMMMMMMMMMM
MMMMMMMMMMXdoo:,;:clooooollloddddddxdddxxxxxxo,......','.........,lxkk0kl::;;cxko;,'''',:cllcclc:::::::;'....,lxkkkkkkxxxxxocoddddocc;';oxx0WMMMMMMMMM
MMMMMMMMMXdoo:,;::::clllooooooodddddddxxxxxxxc...........''''..':oxkO00kc:oxdlldkxl;,;,',cloooolccc;;:;;,'...,okkkkkkkxxxxxxdolllllooo:';oxdKMMMMMMMMM
MMMMMMMMXdlo:,;clcccc:ccloooooodddddddddxxxxx:...........,:::;;:codxkO0xlcodxxl:cooc;:clccc:::;,'''';:;;;;;,,:dkkkkkkxxxxxxxxdlcodxxdol;';dddKMMMMMMMM
MMMMMMMNxloc,;:;:::clc:clloooodddddddddddxxxxl...........;clcc:;;::;;:lc::cc:;,,'...';clool:,,'...',,'',;:cc;;oxkkkkxxxxxxxxddddodddoc::;':ddxXMMMMMMM
MMMMMMWOloc,,:clccccccclllooooooodddodddddxxxd;....''....'''.....';;,';oddl:;...    .;:clllllcc:,.,;,'',;::c:,cxxkkxxxxxdddddddocccccccll,'cdokNMMMMMM
MMMMMMKlll;,;::looolcclllllllooooooooddddddxxd;...''........     .,::,':ddc:'.       ....'',,,c:.';;:ll:,'''..;lddddddddddddddddoccoooool:',ldo0MMMMMM
MMMMMNxcl:,;:::::ccccllllllloodddodddddoddxddl'......'....        ....';kd;''...    ........ .....:c:colllc;,;::llllooddddddddddddollc:cc:;';dodXMMMMM
MMMMM0llc,;:ccccc::::ccloooooddxxxxxxxdooodddc.......'. ..     ........;kk:'''...   ..........','..,:lllccc:::;;:::cloddddddddddddc;;:::clc,'cdoOWMMMM
MMMMNdcl:,:cclllc:::::ccooddddxxddddddooodddd:.........................;kkl;,'...............'::,.....,;::cc::;,,;:cooooooddddddoooc::ccooo:';oodXMMMM
MMMM0lcc;;cccclllcccccloodoooooollllllooddddo;.........................;xkoll:,'............,ldc,.......'',;,,'.,:looooooooodooooddddddooooc,,ldlOMMMM
MMMWk:c:,:c:,:lc:ccccloooolccccclllllloooddo:........................ .;xkdooolcc:;'''',,:coxkd:'.......',;;;,'':ooollllooooooooodddoolcclc:,':olxNMMM
MMMNo:c;,:cc;,;;::::::cccccccllllllooooooodc........... ..'''''',,;,...:xOxodkOxllodddxkO00Okoc,''...:c,''..''..;lollloooooooooooooooc::::,;;',oooKMMM
MMMKc:c;;:clccccccccccc::cclooooollodddddddl...........  .':loooool'. .':cc:;;::;,,lkO00Okkdc;;::;..':cc:'......'clodddooooooolooooool;,;;:c:''lol0MMM
MMM0:::;;:::cloooooooolllllloooooooodddxxxdd:...........  ..;loodol,.......',,,:dxl;:dkkxxo:;coooc,'okxo;......,coooddooooooollloooooolllcllc,'cockWMM
MMMO;::;;,,,;clcllllollooooooooodoooddxxxxxxdl;.........    .':lol:;,,',;'...',;:coolcoxxxc;ldxxdl,.:oc,..''..;looooooooooooollloooooollclllc,':ocxWMM
MMMk;::;;,'';::;:::clllooooodddddddddddxxxxxxxdo:'.. ....    .,c:,.....;oo,'......',:ccodo:cxxxxdc','.....'',cooooooooooddolccloooooolcc:ccc:,.;ocdNMM
MMMk;;;;;;;,'',;:::clloooodddddddddddddxxxxxxxxxdl:,.....    .','......,;;;;;;,.......,:c::oxxxdo;,c;.....',:lolllllooooddol::looooooc::::;,,'.;lcdNMM
MMMk;;;;;;;;;;;:::cclloooodddddoddddddxxxxxxxxxxxdoooc;...    ......',:clllodxxxdolc:'..,,cdxxddl,:o,..',,;:cclllcllooooddlc;;coooollc;,,,,,;'.:lcdNMM
MMMO;,;;;;;:::::::;;;;:cllooooollloodddxddddxxxxxxddoo:....     .','',:clllllldxkkOOOxl:,;ldddol;;dd'..,::;;,,;;:llloooollc:;;clllllccc:::::;'':lcxWMM
MMMK:,;;;,,,;;;;;;;:::;::::::llllcclddollclloodddxddl:,....     .c:....'....',:oxkkOkkdc:ldddol:;dkl...',;''....,cllllllcllcc:cccccccccc::::;''clckWMM
MMMXl';;;,'''''''',,;;;:looollool::ccloooooooooooddddol;....     .,'..','....,oxkOOOOkxooddolc;:dOx:...'..'''...:ooollllllllllcccccccccc::::;',ccc0MMM
MMMWd,,;;,........'',,,,;clodxxxxddddxxxxxxxxxxxxdddoc;'.....     ..',;cllllldkO0000Okdlllc;,;lkOkdc...''......,lolc:::ccccc:::cc::::::::;;;,.;c:lXMMM
MMMMO;',;;'.........'',,'',,:clodxxdooxxxxxxxxxxddool;........     ..';coxxxdoxOOOOkxo:;,'.':dkOkxdc..........'clcc::::::;;;;;;::;;;;,;,,,;,'':c:xNMMM
MMMMXl',;;,............''''''',,;:cllc:codxdddoollllc;'.......       .';coxxo:coddolc,....;oxkkkxdd:'..''.....;cccccccccc::::::::;;;;,,,,,;,.,c:c0MMMM
MMMMWk,',;;...................'''''',;,'';::::ccllllc:'.......        ...',,,'..''......;ldxxkkxxdo:,,'.....';cc::::::::::;;;;;;;;,,,,,,,,,'';c;oNMMMM
MMMMMXl'';:,..........'''''''''''''''''',,,,,,,;;:::c:... ....  ..                ...,;ldxxxxkxxxdoc:;'....',;;:;;:cc::::::::;;;:::;;;;;;;,',:;:OWMMMM
MMMMMWO;',;:;;;;;;:::::::::::cccccccccccllllllllllollc'....,,..  ...    ...''',;:ccloodxxxxxxxxxdxo:lo;.   ...',,,cllccccccc:::::::::;;;,,'';:;dNMMMMM
MMMMMMNd'',:;,,,,,,,,;;;;;;;;;;;;;::::::::::::cc::::::,.'...,'.  ..'.  ..,:cllloodddddddddxxxxxxxxoclxdc..   . ..';;;;::::;;;,,,,,,,,,,'''',:;cKMMMMMM
MMMMMMMKc.',:,''''..''''''''',,,,,,,,;;;;;;;;;;;;;;;::;,''.....   .''.  ..,;:clooodddddddddxxxxxxxdcldxdc,..'....',;;::;;,,'',,;;;;,,'....,;,:OWMMMMMM
MMMMMMMW0:.',;'..'''''''',,,,,'''''''',,,,,,,;;;;:;;,,,,,,''...   .','. ..'',;clloooodoodddddddddddllolccol;:oc;'..'''''.................,;,;xNMMMMMMM
MMMMMMMMWk;.';;'.'''..'',,,,,,;;;;;;;;,,,,,;;;::;;;;,,,,,;;;;,'.   .,,....''',;:cllodooooodddoodddolcc:looc:lllclc;,'...'',,,,,,,,,''...';,,dNMMMMMMMM
MMMMMMMMMNk,.';:;'''..''''.......''',,,,,,;;;,,,,'..'',,;;;;,,'..  .';,....'',,;:loddoolloooolooolc:::lc:;:llc:cclllc:;,....'.........',,,,dXMMMMMMMMM
MMMMMMMMMMNk;.';:,..........'',;:cc::;;;;,,,,;;:::::;;;,,,,''....  ..;;,......',:clollllllccccccc;;;;::;;:llcc:cllcclllc:;,'....''....',,,dXMMMMMMMMMM
MMMMMMMMMMMNk;..,;,........''',,''..........',;:::;;,,,,;,''.. ..   .,:;,.....'',::ccccccc:;;::;,,,',,;;:cccc:cllllodddooolc:;;,,,''',,,,dXMMMMMMMMMMM
MMMMMMMMMMMMWO:..,;,...........................''''',;;;;'.... ..    .;:;,'''''',,;;;::::;,,,,,,,'',,,;:lc::::lollooddxxxxxololc,..',,';xNMMMMMMMMMMMM
MMMMMMMMMMMMMW0l'.';:,....................''',,,,,;::,,,..'... ...   .,cc;,''''''''';:::;,,,;,,,'',;,,:cc::::lllcccclooodooddo:;,,,,,':ONMMMMMMMMMMMMM
MMMMMMMMMMMMMMWXd,..,:;'..............'',,,;;;,,,;::,.''.';c;. .'..   .coc,''......';cc;,,,;,,,',,;;;;::::::clol::ccccccccc:,...',,',oKWMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMNOc..';:,............',,,;;;,,'.'''...'.'cxkdc'''.    .:do:,'......,cc;,;:;;,'';::;;::;;;::::lolc:::::::;;'..',,''':xXMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMWKd;..';;..  .......''',;;'............';dxxdc;::'.   'ldoc;.....':c::clc;,;::c:;;:::,,;;::;cl:::;;::::,..',,''',o0WMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMN0l'..,::,.......''..........'.........,:cc;,codo:'..:dol:'...':oddol:::ccc:;;::;:;,'',;;;:::::::,,;,..,,,'''ckNMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMWNkc'..,::,..........',,,''.............''.';;:looolclooc'..';:clc;;;ccc:;,,;;,;;;,,;,'';:c:;,;;'''.',,''':xXWMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMWXkc'..,;:,.......',''....................,'',,;cooolc,...'',,,',;;;;;,,,;;,,;;,''cl:'..';;,,,,,,,,''':xKWMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMWXkc,..';;,.....','..............'.... .''.'',:odo;...',,,,'''',,;;,',;;,,;;,,..;lcc;'...',;,,''',cxKWMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMWXOo;...',,,...'...............';;'. ..'..'';co:'.'',,'''...',,,,,;;;;,;:,,'...;:;;,..',,,'.';lOXWMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMNKxc,...,,,,,................':c:'..'..'',;:;,,,,''......','',,;:;',;,'''...',,;;,,,'.',cx0NWMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0d:'...,;;;,'.....'. .....'';;,',;,''''''''......'...''.';,,;,,,''',,'..,;;,,'.',:dOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0dc,....,;;;,,,,'.......''........................'...,'',''',',;::;,,'..',cdOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWN0xl;'....,,;::;,,,'...',...........'''.............''.',;;:;;,,'..',:lx0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNX0xl:,'....',;;;;;;;:;;;,,''........'''''',,;;,,;;;;,,'....',:lx0XNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWXKOxl:;'......',,;;;;;;;;;;;;;;;;;;;;;;;;,,'.....',;:ldOKXNWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNK0kxoc:;,'.........................'',;:codk0KNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNXXK0OkxdollccccccccccclloodxkO0KXXNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWWWWNNNNNNNNNNNNWWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM                            
*/

pragma solidity ^0.8.19;

import "./IUniswapV2Router02.sol";
import "./IERC1155.sol";
import "./IERC20.sol";
import "./Counters.sol";
import "./Ownable.sol";
import "./SafeMath.sol";
import "./VRFCoordinatorV2Interface.sol";
import "./VRFConsumerBaseV2.sol";
import "./IFloridaManCard.sol";

contract FloridaManFlip is VRFConsumerBaseV2, Ownable {
    using Counters for Counters.Counter;
    using SafeMath for uint256;

    Counters.Counter public gameId;

    struct Game {
        uint256 id;
        uint256 cardId;
        uint256 bet;
        bool exists;
        bool finished;
        bool heads;
        bool fman;
        address payable player;
        address payable winner;
        uint256[] randomWords;
    }

    uint256 public minimumETHBetUSD = 20;
    uint256 public maximumETHBetUSD = 100;
    uint256 public minimumFMANBetUSD = 20;
    uint256 public maximumFMANBetUSD = 100;

    mapping(uint256 => Game) public gameMapping;
    mapping(uint256 => uint256) public requestIdToGameId;

    VRFCoordinatorV2Interface _vrfCoordinator;
    uint64 private _vrfSubscriptionId;
    bytes32 private _vrfKeyHash;
    uint32 private _vrfGasLimit = 200000;
    uint16 private _vrfRequestConfirmations = 3;

    uint16 private _maxWinPercentage = 35;
    uint16 private _maxWinDropPercentage = 45;

    address payable private _developerAddress;
    address private _cardAddress = 0x4fA9616AbBbFaf2EC503ade5FA3622b3604e5232;
    address private _tokenAddress = 0xD56990D60A7Abf3a7945F0565A98A708234b802C;
    address private _wethAddress = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address private _usdcAddress = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    address private _routerAddress = 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D;

    event GameStarted(address indexed creator, uint256 indexed gameId, uint256 requestId);
    event GameFinished(uint256 indexed gameId, address indexed winner, uint256 result);
    event RandomnessFulfilled(uint256 requestId, uint256[] randomWords);
    event MinimumBetChanged(uint256 newBet, address changedBy);
    event MaximumBetChanged(uint256 newBet, address changedBy);

    constructor(address __developerAddress, address _coordinator, bytes32 _keyHash, uint64 _subscriptionId)
        VRFConsumerBaseV2(_coordinator)
    {
        _developerAddress = payable(__developerAddress);
        _vrfCoordinator = VRFCoordinatorV2Interface(_coordinator);
        _vrfKeyHash = _keyHash;
        _vrfSubscriptionId = _subscriptionId;
    }

    // //////////////////////////////////////////
    // PUBLIC
    // //////////////////////////////////////////
    function getMinimumETHBet() public view returns (uint256) {
        return _getETHFromUSD(minimumETHBetUSD);
    }

    function getMinimumFMANBet() public view returns (uint256) {
        return _getFMANFromUSD(minimumETHBetUSD);
    }

    function getMaximumETHBet() public view returns (uint256) {
        return _getETHFromUSD(maximumETHBetUSD);
    }

    function getMaximumFMANBet() public view returns (uint256) {
        return _getFMANFromUSD(maximumFMANBetUSD);
    }

    function play(uint256 _cardId, bool _heads) external payable returns (uint256) {
        require(msg.value <= address(this).balance, "Bet must less than contract balance");

        uint256 minBet = getMinimumETHBet();
        require(msg.value >= minBet, "Bet must be more than minimum");
        uint256 maxBet = getMaximumETHBet();
        require(msg.value <= maxBet, "Bet must be less than maximum");

        require(IERC1155(_cardAddress).balanceOf(msg.sender, _cardId) > 0, "Must own at least 1 card");
        IFloridaManCard(_cardAddress).safeTransferFrom(msg.sender, address(this), _cardId, 1, "");

        return _play(_cardId, _heads, msg.value, false);
    }

    function playFMAN(uint256 _cardId, bool _heads, uint256 _bet) external payable returns (uint256) {
        require(_bet <= IERC20(_tokenAddress).balanceOf(address(this)), "Bet must less than contract FMAN balance");

        uint256 minBet = getMinimumFMANBet();
        require(_bet >= minBet, "Bet must be more than minimum");
        uint256 maxBet = getMaximumFMANBet();
        require(_bet <= maxBet, "Bet must be less than maximum");

        require(IERC20(_tokenAddress).balanceOf(_msgSender()) >= _bet, "Bet is greater than FMAN balance");
        require(IERC20(_tokenAddress).transferFrom(_msgSender(), address(this), _bet), "Failed to transfer FMAN");

        require(IERC1155(_cardAddress).balanceOf(msg.sender, _cardId) > 0, "Must own at least 1 card");
        IFloridaManCard(_cardAddress).safeTransferFrom(msg.sender, address(this), _cardId, 1, "");

        return _play(_cardId, _heads, _bet, true);
    }

    function getGame(uint256 _id) external view returns (Game memory) {
        return gameMapping[_id];
    }

    function isGamePending(uint256 _id) external view returns (bool) {
        return gameMapping[_id].exists && !gameMapping[_id].finished;
    }

    function isGameComplete(uint256 _id) external view returns (bool) {
        return gameMapping[_id].exists && gameMapping[_id].finished;
    }

    function onERC1155Received(address, address, uint256, uint256, bytes memory) public virtual returns (bytes4) {
        return this.onERC1155Received.selector;
    }

    function onERC1155BatchReceived(address, address, uint256[] memory, uint256[] memory, bytes memory)
        public
        virtual
        returns (bytes4)
    {
        return this.onERC1155BatchReceived.selector;
    }

    function onERC721Received(address, address, uint256, bytes memory) public virtual returns (bytes4) {
        return this.onERC721Received.selector;
    }

    // //////////////////////////////////////////
    // VRF
    // //////////////////////////////////////////
    function fulfillRandomWords(uint256 _requestId, uint256[] memory _randomWords) internal override {
        emit RandomnessFulfilled(_requestId, _randomWords);

        uint256 _gameId = requestIdToGameId[_requestId];

        require(gameMapping[_gameId].exists, "Game does not exist");
        require(!gameMapping[_gameId].finished, "Game is not in the right state");

        bool isCardDroppable = IFloridaManCard(_cardAddress).isMintDroppable(gameMapping[_gameId].cardId);

        uint256 seed = (_randomWords[0] % 100) + 1;
        uint256 maxWinPercentage = _maxWinPercentage;

        if (isCardDroppable) {
            maxWinPercentage = _maxWinDropPercentage;
        }

        if (seed <= maxWinPercentage) {
            gameMapping[_gameId].winner = gameMapping[_gameId].player;

            if (gameMapping[_gameId].fman) {
                require(
                    IERC20(_tokenAddress).transfer(gameMapping[_gameId].player, gameMapping[_gameId].bet * 2),
                    "Failed to transfer winnings"
                );
            } else {
                payable(gameMapping[_gameId].player).transfer(gameMapping[_gameId].bet * 2);
            }
        } else {
            gameMapping[_gameId].winner = payable(address(this));
        }

        gameMapping[_gameId].randomWords = _randomWords;
        gameMapping[_gameId].finished = true;

        emit GameFinished(_gameId, gameMapping[_gameId].winner, seed);
    }

    // //////////////////////////////////////////
    // OWNER
    // //////////////////////////////////////////
    function changeKeyHash(bytes32 _newHash) external onlyOwner {
        _vrfKeyHash = _newHash;
    }

    function changeMinimumFMANBet(uint256 _usd) external onlyOwner {
        minimumFMANBetUSD = _usd;

        emit MinimumBetChanged(_usd, msg.sender);
    }

    function changeMinimumETHBet(uint256 _usd) external onlyOwner {
        minimumETHBetUSD = _usd;

        emit MinimumBetChanged(_usd, msg.sender);
    }

    function changeMaximumFMANBet(uint256 _usd) external onlyOwner {
        maximumFMANBetUSD = _usd;

        emit MaximumBetChanged(_usd, msg.sender);
    }

    function changeMaximumETHBet(uint256 _usd) external onlyOwner {
        maximumETHBetUSD = _usd;

        emit MaximumBetChanged(_usd, msg.sender);
    }

    function withdrawCards() external onlyOwner {
        uint256[] memory ids = IFloridaManCard(_cardAddress).getCardIds();
        uint256[] memory quantities = new uint256[](ids.length);

        for (uint256 i = 0; i < ids.length; i++) {
            quantities[i] = IFloridaManCard(_cardAddress).balanceOf(address(this), ids[i]);
        }

        IERC1155(_cardAddress).safeBatchTransferFrom(address(this), owner(), ids, quantities, "");
    }

    function withdrawETH() external onlyOwner {
        uint256 balance = address(this).balance;

        uint256 developerBalance = balance.mul(1000).div(10000);
        uint256 ownerBalance = balance.sub(developerBalance);

        payable(_developerAddress).transfer(developerBalance);
        payable(owner()).transfer(ownerBalance);
    }

    function withdrawFMAN() external onlyOwner {
        IERC20(_tokenAddress).transfer(msg.sender, IERC20(_tokenAddress).balanceOf(address(this)));
    }

    // //////////////////////////////////////////
    // PRIVATE
    // //////////////////////////////////////////
    function _play(uint256 _cardId, bool _heads, uint256 _bet, bool _fman) private returns (uint256) {
        uint256 _id = gameId.current();
        gameId.increment();
        Game memory _game = Game({
            id: _id,
            cardId: _cardId,
            player: payable(msg.sender),
            bet: _bet,
            heads: _heads,
            fman: _fman,
            finished: false,
            winner: payable(address(0)),
            randomWords: new uint256[](0),
            exists: true
        });
        gameMapping[_id] = _game;

        uint256 requestId = _vrfCoordinator.requestRandomWords(
            _vrfKeyHash, _vrfSubscriptionId, _vrfRequestConfirmations, _vrfGasLimit, 1
        );
        requestIdToGameId[requestId] = _id;

        emit GameStarted(msg.sender, _id, requestId);

        return _id;
    }

    function _getETHFromUSD(uint256 _usd) internal view returns (uint256 amount) {
        address[] memory path = new address[](2);
        path[0] = _usdcAddress;
        path[1] = _wethAddress;

        uint256[] memory amounts = IUniswapV2Router02(_routerAddress).getAmountsOut(_usd * (10 ** 6), path);

        return amounts[1];
    }

    function _getFMANFromUSD(uint256 _usd) internal view returns (uint256 amount) {
        address[] memory path = new address[](3);
        path[0] = _usdcAddress;
        path[1] = _wethAddress;
        path[2] = _tokenAddress;

        uint256[] memory amounts = IUniswapV2Router02(_routerAddress).getAmountsOut(_usd * (10 ** 6), path);

        return amounts[2];
    }
}
