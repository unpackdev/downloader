// SPDX-License-Identifier: UNLICENSED

// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNXKOkkxxxkkO0KNWMMMMMMMMMMMMMMMMMMMMMMWNXKOkkxxxxkO0KXNWMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0xoc:;,,,,,,,,,;;coxOKXWMMMMMMMMMMMMMWNKkdl:;,,,,,,,,,,;:ldkKNMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdc;,,,,,,,,,,,,,,,,,,,,;:oONWMMMMMMMMNKxl;,,,,,,,,,,,,,,,,,,,,;lxKWMMMMMMMMMMMMMM
// MMMMMMMWX0KKKKKKKKKKKKKKKKKKKKK0Oxl;,,,,,,,,,,,,,,,,,,,,,,,,,,;cxO0KKKK0ko:,,,,,,,,,,,,,,,,,,,,,,,,,,:ok0KK00XWMMMMMM
// MMMMMMMWOkXXXXXXNNNNXXXXXXXXXXKxc,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:xKXX0l;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;o0XXkOWMMMMMM
// MMMMMMMWO0WMMMMMMMMMMMMMMMMMMNk:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:dOkl,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,lKWOOWMMMMMM
// MMMMMMMWO0MMMMMMMMMMMMMMMMMMNx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,l0OOWMMMMMM
// MMMMMMMNO0MMMMMMMMMMMMMMMMMWk:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,ldOWMMMMMM
// MMMMMMMNO0MMMMMMMMMNNNNXXXX0l,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:kWMMMMMM
// MMMMMMMNO0MMMMMMMMWOk000KKK0kkkkkkkkkkkkkkkkkxdl:;,,,,,,,,;:cdxkkkkkkkkkkkxdl:,,,,,,,,,;coxkkkkkko;,,,,,,,,,;kWMMMMMM
// MMMMMMMNk0MMMMMMMMNO0WMMMMMMMMMMMMMMMMMMMMWXOdc;,,,,,,,,,,,,;:okKWMMMMMWXOdc;,,,,,,,,,,,;:okKWMMWO:,,,,,,,,,;kWMMMMMM
// MMMMMMMNk0MMMMMMMMNO0MMMMMMMMMMMMMMMMMMMWXkc,,,,,,,,,,,,,,,,,,,,:xKWMMXkc;,,,,,,,,,,,,,,,,,,:dKWWO:,,,,,,,,,;kWMMMMMM
// MMMMMMMNk0MMMMMMMWNO0MMMMMMMMMMMMMMMMMMW0l,,,,,,,,,,,,,,,,,,,,,,,,ckXOl;,,,,,,,,,,,,,,,,,,,,,,:kNO:,,,,,,,,,;kWMMMMMM
// MMMMMMMNk0MMWNKOkdll0MMMMMMMMMMMMMMMMMWOc,,,,,,,,,,,,,,,,,,,,,,,,,,;:;,,,,,,,,,,,,,,,,,,,,,,,,,;dx:,,,,,,,,,;kWMMMMMM
// MMMMMMMNkOX0xl:,,,,:0MMMMMMMMW0O000000Odlllllllllc:;,,,,,,,;:cllllllllc:,,,,,,,;:cllll:,,,,,,,,,;:;,,,,,,,,,;kWMMMMMM
// MMMMMMMNxlc;,,,,,,,:0MMMMMMMMNk0WWWWWWWWWWWWWWNKko:;,,,,,,,;:okKNWWNKkl:,,,,,,,,:okKNNk;,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMMMMMXx:,,,,,,,,,,:0MMMMMMMMNOKMMMMMMMMMMMMMNkc;,,,,,,,,,,,,,;lONNOc;,,,,,,,,,,,,,ckXk;,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMMMW0l,,,,,,,,,,,,:0MMMMMMMMNkKMMMMMMMMMMMMXd;,,,,,,,,,,,,,,,,,;ll;,,,,,,,,,,,,,,,,;od;,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMMWO:,,,,,,,,,,,,,:0MMMMMMWNOxKMMMMMMMMMMMWx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMWO:,,,,,,,,,,,,,,:0MMMWXOdc;c0MMMMMMMMWXKOl,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMKl,,,,,,,,,,,,,,,:0MWKxc,,,,c0MMMMMMMWXkk0000000Oxl;,,,,,,:okOkl;,,,,,:oko;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MWk;,,,,,,,,,,,,,,,:0Nkc,,,,,,c0MMWNKkdoll0WMMMMMW0l,,,,,,,,,;oxl;,,,,,,,;oo;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MNd,,,,,,,,,,,,,,,,ckx;,,,,,,,c0WXxl;,,,,c0MMMMMMKc,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MXo,,,,,,,,,,,,,,,,;c;,,,,,,,,cOkc,,,,,,,c0MMWWNXx;,,,,;c:,,,,,,,,,,::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MNd,,,,,,,,,,,,,,,,,,,,,,,,,,,:c;,,,,,,,,c0XOdlc:;,,,,,l0Kxol:;;;:okKx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MWk;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:oc,,,,,,,,,,:OWMWWNXKKKXWWWx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMKl,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;;cxKWMMMMMMMMMMMMWx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;kWMMMMMM
// MMWO:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;lOKNWMMMMMMMMMMMMMMWkc::::;;:::::::::;;:::::::::;;::::::::::kWMMMMMM
// MMMWO:,,,,,,,,,,,,,;c;,,,,,,,,;;,,,,,,,,,,;,,,,,,;dXMMMMMMMMMMMMMMMMMNXXXXXxxXXXXXXXXXxxKXXXXXXXXkxKXXXXXXXKxOWMMMMMM
// MMMMW0l,,,,,,,,,,,,:kd;,,,,,,,cxo;,,,,,,,:xd:,,,,,,dNMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMMMMXx:,,,,,,,,,,c0Nkc,,,,,,c0NOl;,,,,,c0Kd;,,,,,oXMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMW0OWMMMMMMMWOOWMMMMMM
// MMMMMMMNxll;,,,,,,,c0WWKxc,,,,cKMWNk:,,,,:oc,,,,,,;kWMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMW0OWMMMMMMMWOOWMMMMMM
// MMMMMMMNk0N0o;,,,,,c0MMMWXkc,,c0WKxc,,,,,,,,,,,,,ckNMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMMMMMNk0NKd;,,,,,c0MMMWKkc,,cOkc,,,,,,,,,,,,,,;ldxxxxxxKWMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMMMMMNxol:,,,,,,,c0MWKd:,,,,:c;,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMMMWXx:,,,,,,,,,,c0Xx:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMMW0l,,,,,,,,,,,,ckd;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,o0K00KK00000000000k0WMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMMWO:,,,,,,,,,,,,,;c;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,dXNNNNNNNNWWWNNNNWWWMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMWO:,,,,,,,,,,,,,,,,,,,,,,,,,;:,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMKl,,,,,,,,,,,,,,,,,,,,,,,,,,ckd;,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MWx;,,,,,,,,,,,,,,,,,,,,,,,,,,cKNOl;,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MXo,,,,,,,,,,,,,,,,,,,,,,,,,,,ckKK0xl:,,,,,,,,,,,,,,,,,,,oKXXXXXXXXXXXXXXXXXXXXXXXXXXKxOWMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MXo,,,,,,,,,,,,,,,,:l:,,,,,,,,,;;;;;;;,,,,,,,,,,,,,,,,,,,o0KKKKKKKKKKKKKKKKKKKKKKKKKKK0XMMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MXo,,,,,,,,,,,,,,,,cOx;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MWx;,,,,,,,,,,,,,,,c0NOc,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMKc,,,,,,,,,,,,,,,c0MWXkl;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMMMWOOWMMMMMM
// MMWO:,,,,,,,,,,,,,,c0WWWWXOdl:,,,,,,,,,,,,,,,,,,,,,,,,,,,xNWMMMWWMMMMMMMMMMMMMMMMMMMMMMMWWWWWWWWWOOWMMMMMMMWOOWMMMMMM
// MMMWk:,,,,,,,,,,,,,;lodddooolc;,,,,,,,,,,,,,,,,,,,,,,,,,,o0K00KKKKKKKKKKKKKKKKKKKKKKKKKKKKK000KK0OKWMMMMMMMWOOWMMMMMM
// MMMMW0l,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;xNWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWMMMMMMMMMWOOWMMMMMM
// MMMMMWXx:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMM
// MMMMMMMXxlc;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,;xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMM
// MMMMMMMNk0N0xl:;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWOOWMMMMMM
// MMMMMMMNkkKKK0kdl:;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;d0KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK0x0MMMMMMM
// MMMMMMMWXKKKKKKKKKK000000000000000000000000000KKK00000000KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKNMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// ███╗   ███╗ █████╗ ██████╗ ███████╗   ██╗    ██╗██╗████████╗██╗  ██╗   ███╗   ███╗ █████╗ ███████╗ ██████╗ ███╗   ██╗
// ████╗ ████║██╔══██╗██╔══██╗██╔════╝   ██║    ██║██║╚══██╔══╝██║  ██║   ████╗ ████║██╔══██╗██╔════╝██╔═══██╗████╗  ██║
// ██╔████╔██║███████║██║  ██║█████╗     ██║ █╗ ██║██║   ██║   ███████║   ██╔████╔██║███████║███████╗██║   ██║██╔██╗ ██║
// ██║╚██╔╝██║██╔══██║██║  ██║██╔══╝     ██║███╗██║██║   ██║   ██╔══██║   ██║╚██╔╝██║██╔══██║╚════██║██║   ██║██║╚██╗██║
// ██║ ╚═╝ ██║██║  ██║██████╔╝███████╗   ╚███╔███╔╝██║   ██║   ██║  ██║   ██║ ╚═╝ ██║██║  ██║███████║╚██████╔╝██║ ╚████║
// ╚═╝     ╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝    ╚══╝╚══╝ ╚═╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝

pragma solidity ^0.8.16;

import "./ERC721ABurnable.sol";
import "./ERC721AQueryable.sol";
import "./AccessControl.sol";
import "./Claimable.sol";
import "./EIP712Common.sol";
import "./Ownable.sol";
import "./Payable.sol";
import "./Toggleable.sol";
import "./ERC721A.sol";

error ExceedsMaxPerWallet();
error ExceedsMaxSupply();
error InsufficientPayment();
error TokensAlreadyClaimed();

contract EarlyMajority is ERC721ABurnable, ERC721AQueryable, Ownable, Payable, AccessControl, Toggleable, EIP712Common, Claimable {

  uint256 public MAX_PER_WALLET;
  uint256 public MAX_SUPPLY;
  uint256 public PRICE;

  address private royaltyAddress;
  uint256 private royaltyPercent;

  constructor (
    string memory _tokenName,
    string memory _tokenSymbol,
    string memory _customBaseURI,
    uint256 _tokenPrice,
    uint256 _tokensForSale,
    address _royaltyAddress,
    uint256 _royaltyPercent
  ) ERC721A(_tokenName, _tokenSymbol) {
    customBaseURI = _customBaseURI;

    MAX_SUPPLY = _tokensForSale;
    PRICE = _tokenPrice;
    MAX_PER_WALLET = 3;

    royaltyAddress = _royaltyAddress;
    royaltyPercent = _royaltyPercent;

    _setRoyalties(_royaltyAddress, _royaltyPercent);
  }

  /** MINTING **/

  function mint(uint256 _count) external payable noContracts requireActiveSale {
    if(_totalMinted() + _count > MAX_SUPPLY) revert ExceedsMaxSupply();
    if(msg.value < PRICE * _count) revert InsufficientPayment();

    if(_numberMinted(msg.sender) + _count > MAX_PER_WALLET + _getAux(msg.sender)) revert ExceedsMaxPerWallet();

    _mint(msg.sender, _count);
  }

  function ownerMint(uint64 _count, address _recipient) external onlyOwner {
    if(_totalMinted() + _count > MAX_SUPPLY) revert ExceedsMaxSupply();

    _mint(_recipient, _count);
    _setAux(_recipient, _count);
  }

  function whitelistMint(uint256 _discountedPrice, uint256 _count, bytes calldata _signature) external payable requiresDiscount(_signature, _discountedPrice) requireActiveWhitelist noContracts {
    if(_totalMinted() + _count > MAX_SUPPLY) revert ExceedsMaxSupply();

    if(_numberMinted(msg.sender) + _count > MAX_PER_WALLET + _getAux(msg.sender)) revert ExceedsMaxPerWallet();
    if(msg.value < _discountedPrice * _count) revert InsufficientPayment();

    _mint(msg.sender, _count);
  }

  function claim(uint64 _count, bytes calldata _signature) external payable requiresClaim(_signature, _count) requireActiveClaiming noContracts {
    if(_totalMinted() + 1 > MAX_SUPPLY) revert ExceedsMaxSupply();

    if (hasUnclaimedTokens(msg.sender)) {
      _updateClaimCount(msg.sender, _count);
    } else {
      revert TokensAlreadyClaimed();
    }

    _mint(msg.sender, _count);
    _setAux(msg.sender, _count);
  }

  /** MINTING LIMITS **/
  function allowedMintCount(address _minter) public view returns (uint256) {
    return MAX_PER_WALLET + _getAux(_minter) - _numberMinted(_minter);
  }

  /** WHITELIST **/

  function checkWhitelist(uint256 _discountedPrice, bytes calldata _signature) public view requiresDiscount(_signature, _discountedPrice) returns (bool) {
    return true;
  }

   /** ADMIN **/
  function setMaxPerWallet(uint256 _max) external onlyOwner() {
    MAX_PER_WALLET = _max;
  }

  function setPrice(uint256 _tokenPrice) external onlyOwner {
    PRICE = _tokenPrice;
  }

  /** URI HANDLING **/

  string private customBaseURI;

  function baseTokenURI() public view returns (string memory) {
    return customBaseURI;
  }

  function setBaseURI(string memory customBaseURI_) external onlyOwner {
    customBaseURI = customBaseURI_;
  }

  function _baseURI() internal view virtual override returns (string memory) {
    return customBaseURI;
  }

  function _startTokenId() internal view virtual override returns (uint256) {
    return 1;
  }

  /** PAYOUT **/
  function _setRoyalties(address _receiver, uint256 _percentage) internal {
    royaltyAddress = _receiver;
    royaltyPercent = _percentage;
  }

  function royaltyInfo(uint256 _tokenId, uint256 _salePrice) external view returns (
    address receiver,
    uint256 royaltyAmount
  ) {
    receiver = royaltyAddress;

    royaltyAmount = _salePrice * royaltyPercent / 10000;
  }
}
