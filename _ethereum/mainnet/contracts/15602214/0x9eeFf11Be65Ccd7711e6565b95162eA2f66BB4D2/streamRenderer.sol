// SPDX-License-Identifier:Unlicensed
pragma solidity >= 0.8.16;

import "./Base64.sol";
import "./Strings.sol";


contract Renderer{
    
    function render(string memory blockNumber, bytes32 blockHash , string memory wsProvider) public view returns (string memory renderedContract) {
        // initialize all variables
        bytes memory html; 
        html = abi.encodePacked('<!doctype html><html><head><meta name=viewport content="width=device-width,initial-scale=1"><title>The Stream</title><style>body,html{width:100vw;height:100vh;margin:0;padding:0;background-color:#000;transition:opacity .2s ease-in}body{filter:brightness(1.3) contrast(1.1)}.lightMode{filter:invert(1) contrast(1.08)!important}@keyframes fadeIn{0%{mask:linear-gradient(90deg,#000 25%,#000000e6 50%,#00000000) 150% 0/400% no-repeat;opacity:0}100%{mask:linear-gradient(90deg,#000 25%,#000000e6 50%,#00000000) 0/400% no-repeat;opacity:1}}@keyframes fadeOut{0%{mask:linear-gradient(90deg,#000 25%,#000000e6 50%,#00000000) 150% 0/400% no-repeat;opacity:1}50%{mask:linear-gradient(90deg,#000 25%,#000000e6 50%,#00000000) 0/400% no-repeat;opacity:0}100%{mask:linear-gradient(90deg,#000 25%,#000000e6 50%,#00000000) 150% 0/400% no-repeat;opacity:1}}canvas{width:50%;height:50%;filter:drop-shadow(0px 0px 6px black) invert(1);top:0;padding:0}#canvas2{transform-origin:center center;transform:scaleX(-1);margin-left:-1px}#canvas3{transform-origin:center center;transform:scaleY(-1)}#canvas4{transform-origin:center center;transform:scale(-1);margin-left:-1px}#wrapper{background-color:#000;width:80vw;height:80vh;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border:solid .2px rgba(255,255,255,.4);box-shadow:inset 0 0 150px rgb(225 215 255 / 22%);opacity:0;transition:opacity 5s ease-in;display:flex;flex-wrap:wrap}#title{color:rgb(255,255,255,.3);font-family:sans-serif;font-size:.7em;margin:auto;left:0;right:0;opacity:0;text-align:center;bottom:7vh;position:absolute;transition:opacity .4s ease-in}.infader{animation:fadeIn 10s}.outfader{animation:fadeOut 20s}.visible{opacity:1!important}#bg{width:100%;height:100%}#spinner{margin:auto;left:0;right:0;top:0;bottom:0;position:absolute;opacity:.4;transition:all 2s ease-in}.loader{font-size:6px;margin:50px auto;text-indent:-9999em;width:3em;height:3em;border-radius:50%;background:#fff;background:linear-gradient(to right,#fff 10%,rgba(255,255,255,0) 42%);position:relative;-webkit-animation:load3 1.5s infinite linear;animation:load3 1.5s infinite linear;-webkit-transform:translateZ(0);-ms-transform:translateZ(0);transform:translateZ(0)}.loader:before{width:50%;height:50%;background:#fff;border-radius:100% 0 0 0;position:absolute;top:0;left:0;content:""}.loader:after{background:#000;width:85%;height:85%;border-radius:50%;content:"";margin:auto;position:absolute;top:0;left:0;bottom:0;right:0}@-webkit-keyframes load3{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes load3{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}</style></head><body class=lightMode><div id=bg onclick=event.stopPropagation(),toggleLightMode()></div><div id=spinner class=loader></div><div id=wrapper onmouseenter=toggleTitle() onclick=togglePause() onmouseleave=toggleTitle()><canvas id=canvas></canvas><canvas id=canvas2></canvas><canvas id=canvas3></canvas><canvas id=canvas4></canvas></div><div id=title>Loading...</div><script>const scaleFactor=2e3,baseRates=Array(4).fill(.0025);baseRates.push(1e-4/2e3);const length=1,spaceBetweenLines=6,lineWidth=5,lineHeight=5,wsProvider="' , wsProvider , '",fps=120,interval=1e3/120;var delta,now,r,vals,random,socket,p,rates=[...baseRates],isPaused=!1,started=!1,block={},then=0,points=[],x=0,y=0;const canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),canvas2=document.getElementById("canvas2"),context2=canvas2.getContext("2d"),canvas3=document.getElementById("canvas3"),context3=canvas3.getContext("2d"),canvas4=document.getElementById("canvas4"),context4=canvas4.getContext("2d");var height=canvas.height=canvas2.height=canvas3.height=canvas4.height=.8*window.innerHeight*2,width=canvas.width=canvas2.width=canvas3.width=canvas4.width=.8*window.innerWidth*2;function startWebsocket(){(socket=new WebSocket(wsProvider)).addEventListener("open",(t=>{socket.send(JSON.stringify({id:69420,method:"eth_subscribe",params:["newHeads"]}))})),socket.addEventListener("close",(function(){socket=null,setTimeout(startWebsocket,5e3)})),socket.addEventListener("message",(async function(t){if(t.data.length<500)return void console.warn("WARN: data received too small, aborting");let e=JSON.parse(t.data).params.result;/^0x[0-9A-Fa-f]*$/g.test(e.number)?(block.number=parseInt(e.number,16),/^0x[0-9A-Fa-f]{64}$/g.test(e.hash)?(block.hash=e.hash,started||(await start(),started=!0),updateValues()):console.error("hash fetched is not a hash string, aborting")):console.error("block number fetched is not a hex string, aborting")}))}async function start(){await init(),await initVariables(),document.getElementById("spinner").style.opacity=0,document.getElementById("wrapper").style.opacity=1,requestAnimationFrame(calculatePoints)}function calculatePoints(t){if((delta=t-then)>interval&&!isPaused){for(id in vals)vals[id]+=rates[id];context.clearRect(0,0,canvas.width,canvas.height),context2.clearRect(0,0,canvas.width,canvas.height),context3.clearRect(0,0,canvas.width,canvas.height),context4.clearRect(0,0,canvas.width,canvas.height),p=points[0];let t=height,n=0;for(;t>0&&(context.fillStyle="rgba(0,0,0,.03)",!(n>height));){for(var e=0;e<points.length;e++){var a=getValue((p=points[e]).x,p.y,e);let n=a/13;n>0&&(e==points.length-1&&(n/=2),context.fillStyle="rgba(0,0,0,"+n+")",context.fillRect(6*e,t,6*1.3,6*1.3),context.fillStyle="rgba(0,0,0,.03)"),p.vx+=1*Math.sin(a),p.vy+=1*Math.cos(a),p.vx*=.95,p.vy*=.9,p.x+=p.vx,p.y-=p.vy,context.fillRect(p.x,p.y,5,5),t=p.y}n+=1}canvas2.getContext("2d").drawImage(canvas,0,0),canvas3.getContext("2d").drawImage(canvas,0,0),canvas4.getContext("2d").drawImage(canvas,0,0),init()}then=t-delta%interval,requestAnimationFrame(calculatePoints)}function initVariables(){random=PCGR(),vals=[rnd(0,5,1),rnd(0,5,1),rnd(0,5,1),rnd(0,5,1),rnd(1,3,1)/2e3]}function init(){for(points=[],x=0;x<width;x+=6)points.push({x:x,y:height,vx:0,vy:0})}function displayValues(){console.log("a: "+vals[0],"b: "+vals[1],"n: "+vals[2],"m: "+vals[3],"scale: "+vals[4]),console.log("current FPS: "+1e3/delta)}async function updateValues(){document.getElementById("title").innerHTML="Streaming Block "+block.number+"...",random=PCGR(),target=[rnd(0,5,1),rnd(0,5,1),rnd(0,5,1),rnd(0,5,1),rnd(1,3,1)/2e3];for(let t=0;t<vals.length;t++){let e=Math.sign(target[t]-vals[t]);0==e&&(e=1),rates[t]=e*baseRates[t]}}function getValue(t,e){return t=(t-width/2)*vals[4],e=(e-height/2)*vals[4],vals[0]*Math.sin(vals[2]*Math.PI*t)*Math.sin(vals[3]*Math.PI*e)+vals[1]*Math.sin(vals[3]*Math.PI*t)*Math.sin(vals[2]*Math.PI*e)}function rnd(t,e,a){const n=(random.next()*(e-t)+t).toFixed(a);return parseFloat(n)}function PCGR(t=getStateFromHash(block.hash)){const e=Math.pow(2,-32),a=32557,n=19605;let s=new Uint16Array(4);return i(t),{seed:i,next(){const t=s[0],i=s[1],c=s[2],o=s[3],r=33103+a*t|0,l=63335+a*i+(n*t+(r>>>16))|0,d=31614+a*c+n*i+(62509*t+(l>>>16))|0,h=5125+a*o+(n*c+62509*i)+(22609*t+(d>>>16));s[0]=r,s[1]=l,s[2]=d,s[3]=h;const v=(o<<21)+((o>>2^c)<<5)+((c>>2^i)>>11);return e*((v>>>(o>>11)|v<<(31&-(o>>11)))>>>0)}};function i(t){t||(t=getStateFromHash());for(let e=0;e<s.length;e++)s[e]=t[e]}}function getStateFromHash(t){const e=Math.floor((t.length-2)/2),a=[];for(let n=0;n<e;n++){const e=2+2*n;a.push(parseInt(t.slice(e,e+2),16))}const n=hash32(a,42069),s=hash32(a,69420),i=new Uint16Array(4),c=new DataView(i.buffer);return c.setUint32(0,n),c.setUint32(4,s),i}function hash32(t,e=0){for(var a,n=65535,s=255,i=1540483477,c=t.length,o=e^c,r=0;c>=4;)a=((a=t[r]&s|(t[++r]&s)<<8|(t[++r]&s)<<16|(t[++r]&s)<<24)&n)*i+(((a>>>16)*i&n)<<16),o=(o&n)*i+(((o>>>16)*i&n)<<16)^(a=((a^=a>>>24)&n)*i+(((a>>>16)*i&n)<<16)),c-=4,++r;switch(c){case 3:o^=(t[r+2]&s)<<16;case 2:o^=(t[r+1]&s)<<8;case 1:o=((o^=t[r]&s)&n)*i+(((o>>>16)*i&n)<<16)}return o=((o^=o>>>13)&n)*i+(((o>>>16)*i&n)<<16),(o^=o>>>15)>>>0}function toggleLightMode(){document.body.classList.toggle("lightMode")}function toggleTitle(){document.getElementById("title").classList.toggle("visible")}function togglePause(){isPaused=!isPaused}startWebsocket(),window.addEventListener("resize",(function(t){console.warn("Window resizing detected, adapting..."),height=canvas.height=canvas2.height=canvas3.height=canvas4.height=.8*window.innerHeight*2,width=canvas.width=canvas2.width=canvas3.width=canvas4.width=.8*window.innerWidth*2})),document.addEventListener("keyup",(t=>{"Space"===t.code&&togglePause()}))</script></body></html>');   
        return string(abi.encodePacked('data:application/json;utf8,{"description":"Streaming the blockchain live, for ethernity.","name":"The Stream","attributes":[{"trait_type":"State","value":"Streaming"}],"animation_url":"data:text/html;base64,',Base64.encode(html),'"}'));
    }
}