////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                                            //
//      NNNNNNNN        NNNNNNNN   ffffffffffffffff           tttt                                               iiii                         //
//      N:::::::N       N::::::N  f::::::::::::::::f       ttt:::t                                              i::::i                        //
//      N::::::::N      N::::::N f::::::::::::::::::f      t:::::t                                               iiii                         //
//      N:::::::::N     N::::::N f::::::fffffff:::::f      t:::::t                                                                            //
//      N::::::::::N    N::::::N f:::::f       ffffffttttttt:::::ttttttt      aaaaaaaaaaaaa  nnnn  nnnnnnnn    iiiiiii   aaaaaaaaaaaaa        //
//      N:::::::::::N   N::::::N f:::::f             t:::::::::::::::::t      a::::::::::::a n:::nn::::::::nn  i:::::i   a::::::::::::a       //
//      N:::::::N::::N  N::::::Nf:::::::ffffff       t:::::::::::::::::t      aaaaaaaaa:::::an::::::::::::::nn  i::::i   aaaaaaaaa:::::a      //
//      N::::::N N::::N N::::::Nf::::::::::::f       tttttt:::::::tttttt               a::::ann:::::::::::::::n i::::i            a::::a      //
//      N::::::N  N::::N:::::::Nf::::::::::::f             t:::::t              aaaaaaa:::::a  n:::::nnnn:::::n i::::i     aaaaaaa:::::a      //
//      N::::::N   N:::::::::::Nf:::::::ffffff             t:::::t            aa::::::::::::a  n::::n    n::::n i::::i   aa::::::::::::a      //
//      N::::::N    N::::::::::N f:::::f                   t:::::t           a::::aaaa::::::a  n::::n    n::::n i::::i  a::::aaaa::::::a      //
//      N::::::N     N:::::::::N f:::::f                   t:::::t    tttttta::::a    a:::::a  n::::n    n::::n i::::i a::::a    a:::::a      //
//      N::::::N      N::::::::Nf:::::::f                  t::::::tttt:::::ta::::a    a:::::a  n::::n    n::::ni::::::ia::::a    a:::::a      //
//      N::::::N       N:::::::Nf:::::::f                  tt::::::::::::::ta:::::aaaa::::::a  n::::n    n::::ni::::::ia:::::aaaa::::::a      //
//      N::::::N        N::::::Nf:::::::f                    tt:::::::::::tt a::::::::::aa:::a n::::n    n::::ni::::::i a::::::::::aa:::a     //
//      NNNNNNNN         NNNNNNNfffffffff                      ttttttttttt    aaaaaaaaaa  aaaa nnnnnn    nnnnnniiiiiiii  aaaaaaaaaa  aaaa     //
//                                                                                                                                            //                                    
//                                                               ..::^^^^^^::..                                                               // 
//                                                      .^!JPB&&@@@@@@@@@@@@@@@@&#G5?~:                                                       // 
//                                                 .!5#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&GJ^.                                                 // 
//                                             :?B&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&P!.                                             // 
//                                          ^P&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#J:                                          // 
//                                       ^P@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&J.                                       // 
//                                     ?&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B^                                     // 
//                                  .Y@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&!                                   // 
//                                 Y@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&~                                 // 
//                               !@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:                               // 
//                             .B@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@J                              // 
//                            ~@@@@@@@@@@@@@@@#JJJJJJJJJJJJJJJP@@@@@@@BY!:.         ..^7P&@@@@@@@@@@@@@@@@@@@@@@#.                            // 
//                           J@@@@@@@@@@@@@@@@J               .@@@&Y:                     .?&@@@@@@@@@@@@@@@@@@@@@:                           // 
//                          5@@@@@@@@@@@@@@@@@Y               :@#~                           ^&@@@@@@@@@@@@@@@@@@@@^                          // 
//                         Y@@@@@@@@@@@@@@@@@@Y               .~                               5@@@@@@@@@@@@@@@@@@@@:                         // 
//                        !@@@@@@@@@@@@@@@@@@@Y                                                 G@@@@@@@@@@@@@@@@@@@@.                        // 
//                       .@@@@@@@@@@@@@@@@@@@@Y                                                  @@@@@@@@@@@@@@@@@@@@B                        // 
//                       G@@@@@@@@@@@@@@@@@@@@Y                     ^?5GGBG5?^                   5@@@@@@@@@@@@@@@@@@@@!                       // 
//                      :@@@@@@@@@@@@@@@@@@@@@Y                  .G@@@@@@@@@@@&7                 ~@@@@@@@@@@@@@@@@@@@@&                       // 
//                      P@@@@@@@@@@@@@@@@@@@@@Y                 !@@@@@@@@@@@@@@@!                .@@@@@@@@@@@@@@@@@@@@@^                      // 
//                      &@@@@@@@@@@@@@@@@@@@@@Y                .@@@@@@@@@@@@@@@@#                .@@@@@@@@@@@@@@@@@@@@@5                      // 
//                     .@@@@@@@@@@@@@@@@@@@@@@Y                ?@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@#                      // 
//                     :@@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@&                      // 
//                     :@@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@&                      // 
//                     .@@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@#                      // 
//                      @@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@P                      // 
//                      B@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@!                      // 
//                      ~@@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@@                       // 
//                       &@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@@J                       // 
//                       ^@@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@&                        // 
//                        5@@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@@^                        // 
//                         B@@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@@7                         // 
//                          #@@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@@J                          // 
//                           B@@@@@@@@@@@@@@@@Y                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@@?                           // 
//                            5@@@@@@@@@@@@@@@J                5@@@@@@@@@@@@@@@@&                .@@@@@@@@@@@@@@@~                            // 
//                             ~@@@@@@@@@@@@@@#????????????????#@@@@@@@@@@@@@@@@@????????????????Y@@@@@@@@@@@@@#.                             // 
//                               P@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@?                               // 
//                                ^#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@P.                                // 
//                                  ~#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@P.                                  // 
//                                    ^B@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Y.                                    // 
//                                      .J&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B!                                       // 
//                                         :Y&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#?.                                         // 
//                                            .?B@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&P!.                                            // 
//                                                :7P&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#5!.                                                // 
//                                                     :!JP#&@@@@@@@@@@@@@@@@@@@@@&&B5?^.                                                     // 
//                                                            .:^!7?JY555YYJ?7~^:.                                                            //
//                                                                                                                                            //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////    

// SPDX-License-Identifier: MIT

// @title: Nftania NFT2.0
// @author: Nftania.com
// @custom: security-contact info@nftania.com
// @Contract: Nftania NFT2 Token

    error E_TransferIsFrozen (string message, uint unfreezeDate);
    error E_ContractIsPaused (string message);     

pragma solidity 0.8.15;
   //////////////////////// Imports ////////////////////////////////////////////////////////////
    import "./ERC20.sol";  
    import "./ERC20Snapshot.sol";
    import "./ERC20Burnable.sol";
    import "./Pausable.sol";
    import "./Ownable.sol";                
    import "./draft-ERC20Permit.sol";
    import "./SafeERC20.sol";

   //////////////////////// Contract //////////////////////////////////////////////////////////////
  
contract Nftania_Token is ERC20, ERC20Snapshot, ERC20Burnable, Pausable, Ownable, ERC20Permit {
    using SafeERC20 for IERC20;
   //////////////////////// Supply Settings ////////////////////////////////////////////////////
    // Cap Supply
    uint256 public constant CAP_SUPPLY = uint256 (21e9 ether); // (21 Billion Tokens with 18 decimals)

    // for TEAM.
    uint256 public constant AMOUNT_TEAM_AND_INVESTORS = uint256 (2e9 ether);
    address public immutable  ADDR_TEAM_AND_INVESTORS_lOCKER;

    // for EARLY INVESTORS & SUPPORTERS
    uint256 public constant AMOUNT_COMPANY = uint256 (1e9 ether);
    address public immutable ADDR_COMPANY_lOCKER;

    // For LIQUIDITY POOL
    address public immutable ADDR_LIQUIDITY_lOCKER;

    // for TREASURY
    uint256 public constant AMOUNT_TREASURY = uint256 (18e9 ether);

   //////////////////////// Other State variables ////////////////////////////////////////////////////
    bool private isFrozen;
    uint public tokensReleaseDate;
    uint256 public royaltyRate; // royalty fees rate (unit per thousand)
    address public royaltyWallet;
    address public crowdsaleContract;
    mapping (address => bool) internal isFreezeExempt;  
    mapping (address => bool) internal royaltyExemptTo; // reciveing addresses of Team and contracts are exempted (ie. airdrop, presale)
    mapping (address => bool) internal royaltyExemptFrom; // sending addresses contracts are exempted (ie. airdrop, presale) 

   //////////////////////// Events /////////////////////////////////////////////////////////////
    // Pause/unpause Smart Contract
        event ContractIsPaused (bool status);
    // Unfreeze Tokens
        event TokensUnfrozen (bool status);
    // Updated Token Release Date
        event TokenReleaseDateUpdate (uint newTokenReleaseDate);
    // Withdraw Tokens 
        event WithdrawTokens (address to, uint256  amount);
    // Tansfer
        event TokenTransfer (address from, address to,uint amount, uint balance);

   //////////////////////// Contract Initilaization ////////////////////////////////////////////
    constructor(
        uint _tokensReleaseDate, 
        address _ADDR_LIQUIDITY_lOCKER,
        address _ADDR_TEAM_AND_INVESTORS_lOCKER, 
        address _ADDR_COMPANY_lOCKER,
        address _crowdsaleContract, 
        address _royaltyWallet, 
        uint256 _royaltyRate
        ) 
        ERC20("Nftania", "NFT2") ERC20Permit("Nftania") {


        // Validate Inputs
        
        require(_tokensReleaseDate >= block.timestamp ,"erorr realese date");
        require(_ADDR_LIQUIDITY_lOCKER != address(0),"zero addr");
        require(_ADDR_TEAM_AND_INVESTORS_lOCKER != address(0),"zero addr");
        require(_ADDR_COMPANY_lOCKER != address(0),"zero addr");  
        require(_crowdsaleContract != address(0),"zero address"); 
        require(_royaltyWallet != address(0),"zero addr");
        require(_royaltyRate <= 100,"rate should be <= 100");

        // Set Variables
        isFrozen = true;
        tokensReleaseDate = _tokensReleaseDate;
        ADDR_LIQUIDITY_lOCKER = _ADDR_LIQUIDITY_lOCKER;
        ADDR_TEAM_AND_INVESTORS_lOCKER = _ADDR_TEAM_AND_INVESTORS_lOCKER;
        ADDR_COMPANY_lOCKER = _ADDR_COMPANY_lOCKER;
        crowdsaleContract = _crowdsaleContract;
        royaltyWallet = _royaltyWallet;
        royaltyRate  = _royaltyRate;      

        // Freeze Exempt
        isFreezeExempt[msg.sender] = true;
        isFreezeExempt[ADDR_LIQUIDITY_lOCKER] = true;
        isFreezeExempt[ADDR_TEAM_AND_INVESTORS_lOCKER] = true;    
        isFreezeExempt[ADDR_COMPANY_lOCKER] = true;    
        isFreezeExempt[royaltyWallet] = true; 

        // Contract Royalty Exempt
        addContractExempt(msg.sender);
        addContractExempt(ADDR_LIQUIDITY_lOCKER);
        addContractExempt(ADDR_TEAM_AND_INVESTORS_lOCKER);
        addContractExempt(ADDR_COMPANY_lOCKER);
        addContractExempt(royaltyWallet);

        //Mint
        _mint(_ADDR_TEAM_AND_INVESTORS_lOCKER, AMOUNT_TEAM_AND_INVESTORS);        
        _mint(ADDR_COMPANY_lOCKER, AMOUNT_COMPANY);
        _mint(msg.sender, AMOUNT_TREASURY);
    }

   //////////////////////// Add Freeze Exempt /////////////////////////////////////////////////// 
    //mainly to enable airdrop and crowdsale contracts
    function addFreezeExempt (address addr) public onlyOwner {
        isFreezeExempt[addr] = true;
    }

   //////////////////////// remove Freeze Exempt ///////////////////////////////////////////////////  
    function removeFreezeExempt (address addr) public onlyOwner {
        isFreezeExempt[addr] = false;
    }

   //////////////////////// Check If Freeze Exempt //////////////////////////////////////////////////
    function checkIfFreezeExempt (address wallet) public view returns(bool) {
        return isFreezeExempt[wallet];
    }

   //////////////////////// Fallback Receive ///////////////////////////////////////////////////   
    fallback() external payable {} 
    receive()  external payable {} 

   //////////////////////// Freeze Not Expired Modifier ////////////////////////////////////////  
    modifier freezeNotExpired() {
      require(block.timestamp < tokensReleaseDate,"T: freeze expired");
      _;
    }

   //////////////////////// Freeze Expired Modifier ////////////////////////////////////////////  
    modifier freezeExpired() {
      require(block.timestamp > tokensReleaseDate,"T: release date not achieved");
      _;
    }    

   //////////////////////// update Token Release Date //////////////////////////////////////////  
    function updateTokenReleaseDate(uint newTokenReleaseDate) onlyOwner freezeNotExpired public {
        require(newTokenReleaseDate >= block.timestamp ,"T: date should be future");
        require (newTokenReleaseDate < tokensReleaseDate,"T: date cant be delayed");
        tokensReleaseDate = newTokenReleaseDate;
        emit TokenReleaseDateUpdate (newTokenReleaseDate);
    }

   //////////////////////// Early Unfreeze Tokens (for admin) ////////////////////////////////////////  
    function earlyReleaseTokens() onlyOwner public  {
        require(isFrozen,"T: already Done");
        isFrozen = false;
        emit TokensUnfrozen (!isFrozen);
    }

   //////////////////////// Early Unfreeze Tokens (On liquidity target) ////////////////////////////////////////  
    function releaseOnTarget() external  {
        require(msg.sender == crowdsaleContract,"Invalid Sender");
        isFrozen = false;
        emit TokensUnfrozen (!isFrozen);
    }

   //////////////////////// Checks if tokens are released ////////////////////////////////////////  
    function isTokenReleased() public view returns (bool isReleased) {
        return !isFrozen;
    }

   //////////////////////// Release Tokens /////////////////////////////////  
   ////enables anybody to release tokens after freeze date is realised /////
    function releaseTokens() public freezeExpired  {
        isFrozen = false;
        emit TokensUnfrozen (!isFrozen);
    }

   //////////////////////// Get Balance //////////////////////////////////////////   
    function getEthBalance () external view returns (uint Balance) {
        return address(this).balance;
    }

   //////////////////////// Withdraw Balance //////////////////////////////////////////////////     
    function withdrawEth(uint amount, address payable receivingWallet) public onlyOwner returns (uint256 balance , bool status)  {
        require(amount <= address (this).balance,"T: Insufficient funds");
        (bool success, ) = receivingWallet.call{value: amount}("");
        require(success, "Error");    
        return (address(this).balance,true);
    }

   //////////////////////// Withdraw Tokens ////////////////////////////////    
    function withdrawTokens (IERC20 token, address to, uint256 amount ) public onlyOwner {
        uint256 tokenBalance = token.balanceOf (address(this)) ;
        require (amount <= tokenBalance,"T: low balance") ;
        token.safeTransfer(to,amount);
        emit WithdrawTokens (to, amount);
    }  

   //////////////////////// update Royalty Rate /////////////////////////////////////// 
    function updateRoyalty(uint256 _royaltyRate ) public onlyOwner {
        require (_royaltyRate <= 100,"T: Max is 100"); 
        royaltyRate  = _royaltyRate ;
    }

   //////////////////////// Exclude Project Wallets from incoming Tx royalaties /////////////////////////////////////// 
    function addTeamExempt(address teamAddress) public onlyOwner {
        royaltyExemptTo[teamAddress] = true;
    }

   /////////////// Exclude from royalties if address is Sender or Reciver //////////////
    function addContractExempt(address contractAddress) public onlyOwner {
        royaltyExemptTo[contractAddress] = true;
        royaltyExemptFrom[contractAddress] = true;
    }

   /////////////// Exclude from royalties if address is Sender //////////////
    function addExempt_From(address targetAddress) public onlyOwner {
        require (royaltyExemptFrom[targetAddress] == false, "T: already Done");
        royaltyExemptFrom[targetAddress] = true;
    }

   /////////////// Exclude from royalties if address is Reciever  //////////////
    function addExempt_To(address targetAddress) public onlyOwner {
        require (royaltyExemptTo[targetAddress] == false, "T: already Done");
        royaltyExemptTo[targetAddress] = true;
    }

   //////////////////////// remove From Exempt  ///////////////////////////////////////////////////  
    function removeRoyaltyExempt_From (address addr) public onlyOwner {
        royaltyExemptFrom[addr] = false;
    }

   //////////////////////// remove To Exempt ///////////////////////////////////////////////////  
    function removeRoyaltyExempt_To (address addr) public onlyOwner {
        royaltyExemptTo[addr] = false;
    }

   //////////////////////// Check if royalty Exempted ///////////////////////////////////////////////////  
    function checkRoyaltyExempt (address addr) public view onlyOwner returns (bool _royaltyExemptTo, bool _royaltyExemptFrom){
        return (royaltyExemptTo[addr] ,royaltyExemptFrom[addr]);
    }

   /////////////// calculate royalties for a transaction //////////////
    function calculateRoyalty (address from, address to, uint256 amount) internal view 
        returns (uint256 royaltyAmount, uint256 transferAmount){
        if (royaltyExemptTo[to]||royaltyExemptFrom[from]){
            royaltyAmount = 0;
            transferAmount = amount;
        }
        else{
            require( amount * royaltyRate > 1000,"T: small tx");
            royaltyAmount = (amount * royaltyRate) / 1000;
            transferAmount = amount - royaltyAmount;
        }
        return (royaltyAmount, transferAmount);
    } 

   //////////////////////// add royalty to transfer  //////////////////////////////////// 
    function _transfer(address from, address to, uint256 amount) internal virtual override {
        (uint royaltyAmount,uint transferAmount) = calculateRoyalty(from, to, amount);
        if (royaltyAmount > 0 ){ 
            super._transfer(from, royaltyWallet, royaltyAmount);
        }
        super._transfer(from, to, transferAmount);
        amount = transferAmount;        
    }

   //////////////////////// add event with "balance" with each transfer  /////////////////////     
    function _afterTokenTransfer(address from, address to, uint256 amount) internal override (ERC20){
        super._afterTokenTransfer(from, to, amount);
        uint balance = balanceOf (to);
        emit TokenTransfer (from, to, amount, balance);
    }

   //////////////////////// Pause/UnPause Smart Contract /////////////////////////////////////// 
    function pause() public onlyOwner {
        _pause();
        emit ContractIsPaused (true);        
    }
    function unpause() public onlyOwner {
        _unpause();
        emit ContractIsPaused (false);
    }

   //////////////////////// Pause & Freeze Control ////////////////////////////////////
    function _beforeTokenTransfer(address from, address to, uint256 amount) internal override (ERC20, ERC20Snapshot){
        if (paused()==false){
            if (!isFrozen||isFreezeExempt[msg.sender]){
                super._beforeTokenTransfer(from, to, amount);
            }
            else {
                revert E_TransferIsFrozen ({
                    message: "T: Tokens frozen",
                    unfreezeDate: tokensReleaseDate
                });                                                
            }
        }       
        else {
            revert E_ContractIsPaused({
                message: "T: Paused"
            }); 
        }
    }

   //////////////////////// Snapshot  //////////////////////////////////// 
    function snapshot() public onlyOwner {
        _snapshot();
    }

   /////////////////////// Disable Renounce Ownership //////////////////////////////////// 
    function renounceOwnership() public view override onlyOwner {
        revert("T: Not Allowed");  
    }

   /////////////////////// Override Approve With Increase Allownace  //////////////////////////////////// 
    function approve(address spender, uint256 amount ) public override returns ( bool status){
        return status = increaseAllowance (spender, amount);
    }

}