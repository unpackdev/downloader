// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ .#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@,.%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*.@@@@@@@@@@
// @@@@@@@@@@@@   #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@   &@@@@@@@@@
// @@@@@@@@@@@@    @@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&,   &&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*   &@@@@@@@@@
// @@@@@@@@@@@(   #@@@&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&.   &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&@@@@@@@@@@@    @@@@@@@@@
// @@@@@@&&&&&&   (&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&   %@@@@@@@@@
// &&&&&&&&&&&/    &&&&&&&&&&&&&&&&&&#*,#&&&&&%(**&&&&&&&%%&./&&&&&&&&&,%((&&&&&&%(,/%&&&&&&&&&&&&&&&&&&&&&&*    &&&&&&&@@
// &&&&&&&&&&&     &&&&&&&(,/%&&&&&,**.,(%&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&#(.*%&&&&&&&#*(%&&&&&&&&&&&     (&&&&&&&&
// &&&&&&&&&&&&&&&&%*,#&&(,*(/(%&&&&&&&&**&&&&#/*(%&&&&&&&&, ..*/#&&&&&&&&&#/((#&&&,#&&&&&%(//(.../%#**%&&&&&&&&&&&&&&&&&&
// &&&&&&&&&&&&/.**.,.#(*&&&&&&&&&&&&&&&&&,(&&&&&&&&&&&&(*,    .,/#%(&&&&&&&&&&&&,(&&&&&&&&&&&&&&#,(&&&&&%*/%&&&&&&&&&&&&&
// &&&&&&&&%,/&&&&&/,&&&&&&&&&&&&&&&&&&&&&&#.#&&&&&&&&%/.@@*@@%.%##%.#&&&&&&&&&*(&&&&&&&&&&&&&&&&&&&&%,*%&&&&%./&&&&&&&&&&
// &&&&&&#,/%&*,,,#&&&&&&&&&&&&&&&&&&&&&&&&%/..(&&&&&&&&# ,,  #%%%%&&&&&&&&%(,.(&&&&&&&&&&&&&&&&&&&&&&&&#,(/(%%//.#&&&&&&&
// &&&&&/,#((%&(,%&&&&&&&&&&&&&&%(**(%&&&&&&&&%,*&&&&&&&. .*/*(&&&&&&&&&&&&/*&&&&&&&&%/**#&&&&&&&&&&&&&&&&(.#&&&&%/,#&&&&&
// &&&&%,(/*#&&*/&&&&&#/.,%&&&&&&&&&&&&&&&&&&&&&#,/&&&&&&&&&&&&&&&&&&&&&&(,%&&&&&&&&&&&&&&&&&%&&/,/#&&&&&&%/*,..,,/,,%&&&&
// &&&&&*/.../%%.(%%%%%# .#.*#####(((((((((((((((//.*////////////******,.****************,,.... ,,,,,,**,...*%&&&&%**#&&&&
// &&&&&&/,/#&&&&/*%&&&&     &&&&&&&&&&&&&&&&&&&&&&&/.#&&&&&&&&&&&&&&(.(&&&&&&&&&&&&&&&&&&(     &&&&&&&&%(.((%&#(* ,#&&&&&
// &&&&&&&&(.%&&&(*%/*%&     %&&&&&&&&&&&&&&&&&&&&&&&&/*&&&&&&&&&&&#.(&&&&&&&&&&&&&&&&&&&&      &&&&&&#,*#&&&&&%/.(&&&&&&&
// &&&&&&&&&&&(,#&&&&&&%     %&&&&&&&&&&&&&&&&&&&&&&&&&%,*&&&&&&&%,#&&&&&&&&&&&&&&&&&&&&&&      &&#/./%(*( .*(.*#&&&&&&&&&
// &&&&&&&&&&&&&&&(.(%&      #**#&&&&&&&&&&&&&&&&&&&&&&&&#.#&&&&,(&&&&&&&&&&&&&&&&&&&&&&&&(     ,%&&&&&&%/.*#%&&&&&&&&&&&&
// &&&&&&&&&&&&&&&&&&&&#     (&&&&&&&%/*,*(#&&&&&&&&&&&&&&&#,%,/&&&&&&&&&&&&&&&&%%(/,,,/#%/     *./(,./%&&&&&&&&&&&&&&&&&&
// &&&&&&&&&&&&&&&&&&&&      #%#/,*/(# .../&&&&&&&&%%(//**//**,,***/*/(###%%&&%.  .,%&&&%#      %&&&&&&&&&&&&&&&&&&&&&&&&&
// @&&&&&&&&&&&&&&&&&&&      %&&&&&&&&&&&&%%#(/,...  ,(###%%%%%%%%#,/.,(((//,...,/(##%&&&&      &&&&&&&&&&&&&&&&&&&&&&&&&&
// @@@@@@@@@@@@&&&&&&&,      (&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&#       &&&&&&&&&&&&&&&&&@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

//
// ForgottenPunks: SummoningCircleMinter
//
// Website: https://forgottenpunks.wtf
// Twitter: https://twitter.com/forgottenpunk
//
// SPDX-License-Identifier: MIT

pragma solidity ^0.8.9;

import "./ERC1155.sol";
import "./ReentrancyGuard.sol";
import "./Ownable.sol";
import "./MerkleProof.sol";

interface ForgottenSpellsContract is IERC1155 {
    function tokenSupply(uint256 tokenId) external returns (uint256);

    function mint(
        address initialOwner,
        uint256 tokenId,
        uint256 amount,
        bytes calldata data
    ) external;
}

contract SummoningCircleMinter is Ownable, ReentrancyGuard {
    address public forgottenSpellsAddress;
    uint256 public summoningCircleTokenId = 0;

    bytes32 public merkleRoot;

    bool public mintEnabled = false;
    uint256 public mintPrice = (1 ether * 0.0333);

    bool public claimEnabled = false;
    uint256 public claimsAllowedPerAddress = 1;
    mapping(address => uint) public claimed;

    uint256 public constant MAX_SUPPLY = 666;

    event SummoningCircleMinted(address minter);
    event SummoningCircleClaimed(address claimer);

    constructor(address _forgottenSpellsAddress, bytes32 _merkleRoot) {
        forgottenSpellsAddress = _forgottenSpellsAddress;
        merkleRoot = _merkleRoot;
    }

    function mint() public payable nonReentrant {
        ForgottenSpellsContract spells = ForgottenSpellsContract(
            forgottenSpellsAddress
        );
        uint256 supply = spells.tokenSupply(summoningCircleTokenId);
        require(mintEnabled, "MINT_CLOSED");
        require(supply + 1 <= MAX_SUPPLY, "SOLD_OUT");
        require(msg.value == mintPrice, "INCORRECT_ETH_VALUE");

        spells.mint(msg.sender, summoningCircleTokenId, 1, "");

        emit SummoningCircleMinted(msg.sender);
    }

    function canClaim(address claimer, bytes32[] calldata merkleProof)
        public
        view
        returns (bool)
    {
        return
            claimed[claimer] < claimsAllowedPerAddress &&
            MerkleProof.verify(
                merkleProof,
                merkleRoot,
                keccak256(abi.encodePacked(claimer))
            );
    }

    function claim(bytes32[] calldata merkleProof) public nonReentrant {
        ForgottenSpellsContract spells = ForgottenSpellsContract(
            forgottenSpellsAddress
        );
        uint256 supply = spells.tokenSupply(summoningCircleTokenId);
        require(claimEnabled, "CLAIM_CLOSED");
        require(supply +1 <= MAX_SUPPLY, "SOLD_OUT");
        require(canClaim(msg.sender, merkleProof), "INELIGIBLE_FOR_CLAIM");

        spells.mint(msg.sender, summoningCircleTokenId, 1, "");
        claimed[msg.sender] += 1;

        emit SummoningCircleClaimed(msg.sender);
    }

    function withdraw() public onlyOwner {
        payable(msg.sender).transfer(address(this).balance);
    }

    // Only contract owner shall pass
    function setMerkleRoot(bytes32 _newMerkleRoot) public onlyOwner {
        merkleRoot = _newMerkleRoot;
    }

    function setMintEnabled(bool _newMintEnabled) public onlyOwner {
        mintEnabled = _newMintEnabled;
    }

    function setMintPrice(uint256 _newMintPrice) public onlyOwner {
        mintPrice = _newMintPrice;
    }

    function setClaimEnabled(bool _claimEnabled) public onlyOwner {
        claimEnabled = _claimEnabled;
    }

    function setClaimsAllowedPerAddress(uint256 _newClaimsAllowedPerAddress)
        public
        onlyOwner
    {
        claimsAllowedPerAddress = _newClaimsAllowedPerAddress;
    }
}
